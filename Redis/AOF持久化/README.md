# AOF持久化
通过保存Redis服务器所执行的**写命令**来记录数据库状态。

## 实现
可分为命令追加（append）、文件写入、文件同步（sync）三个步骤。

#### 1. 命令追加
当AOF持久化功能处于打开状态时,服务器在执行完一个**写命令**之后,会以协议格式将被执行的写命令追加到服务器状态的aof-buf缓冲区的末尾。
#### 2. 写入与同步
服务器每次结束一个事件循环之前，会调用flushAppendOnlyFile函数，考虑是否需要将aof_buf缓冲区中的内容写入和保存到AOF文件中。可通过参数appendfsync来决定函数行为：
- always：将aof buf缓冲区中的所有内容写入并同步到AOF文件。
- everysec（默认值）：将aof buf缓冲区中的所有内容写人到AOF文件,如果上次同步AOF文件的时间距离现在超过一秒钟,那么再次对AOF文件进行同步,并且这个同步操作是由一个线程专门负责执行的。
- no：将aof-buf缓冲区中的所有内容写入到AOF文件,但并不对AOF文件进行同步,何时同步由操作系统来决定。

> **文件的写入和同步**<br>
现代操作系统，当用户调用write函数写数据到文件时，操作系统通常会将写入数据暂存到一个内存缓冲区，等缓冲区被填满或超过指定时限后才真正写入磁盘。<br>
这种做法虽然提高了效率,但也为写入数据带来了安全问题,因为如果计算机发生停机,那么保存在内存缓冲区里面的写入数据将会丢失。<br>
为此,系统提供了fsync和fdatasync两个同步函数,它们可以强制让操作系统立即将缓冲区中的数据写入到硬盘里面,从而确保写入数据的安全性。

## 载入与数据还原
还原数据步骤：
1. 创建伪客户端。
2. 从AOF分析读取一条写命令。
3. 执行写命令。
4. 重复执行步骤2、3，直到完毕。

## AOF重写
重新生成新的、高效率的AOF文件。实现：
- 启动子进程，直接读取服务器当前的数据库状态来实现。
- 在重写过程中，主进程执行的写命令，会写入AOF重写缓冲区（AOF缓冲区和AOF重写缓冲区两者都要写入）。
- 重写完成后，用新的AOF文件覆盖现有的旧的AOF文件。