# LocalDNS
## 1.1 概念
域名需要转换为IP地址才能进行HTTP通信，本地域名转换为IP的过程，则是域名解析的过程。

## 1.2 协议
使用53端口进行通信。应用层协议为域名解析协议（DNS协议）。DNS协议的底层使用TCP协议或UDP协议。当使用域传输的时候使用TCP协议，其他时候使用UDP协议。
> **域传输**<br>
指后备服务器从主服务器拷贝数据，并用得到的数据更新自身数据库。

## 1.3 域名服务器
- 根域名服务器<br>
    共13个服务器（注意不是13台物理机），相应是域名是a.rootservers.net,...,m.rootservers.net
- 顶级域名服务器<br>
    负责管理在该顶级域名服务器注册的所有二级域名。
- 权限域名服务器<br>
    DNS服务器的管辖范围不是以“域”为单位，而是以“区”为单位的，域名服务器保存该区中所有主机的域名到IP地址的映射。（区是域的子集）
- 本地域名服务器

## 1.4 解析方式
- 递归查询<br>
    主机向本地域名服务器的查询一般是递归查询。如果主机所查询的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其他根域名服务器继续发出查询请求报文，而不是让该主机自己进行下一步的查询。
- 迭代查询<br>
    本地域名服务器向根域名服务器的查询通常是迭代查询。特点：当根域名服务器收到本地域名服务器发出的迭代查询请求报文，要么给出所要查询的IP，要么告诉下级域名服务器的IP地址，让本地域名服务器继续后续的查询。

具体使用哪种方式，取决于最初的查询请求报文的设置是要求使用哪一种查询方式。

## 1.5 高速缓存
域名服务器中用以存放最近查询过的域名以及从何处获取域名映射信息的记录。

## 1.6 DNS协议报文结构
（略）

## 1.7 缺点
### 1.7.1 域名劫持
表现即域名A应该返回的DNS解析结果IP1被恶意替换为了IP2，导致A的访问失败或访问了一个不安全的站点。

一种可能的域名劫持方式即黑客侵入了宽带路由器并对终端用户的Local DNS进行篡改，指向黑客自己伪造的Local DNS，进而通过控制Local DNS的逻辑返回错误的IP信息进行域名劫持。另一方面，由于DNS解析主要是基于UDP协议，除了上述攻击行为外，攻击者还可以监听终端用户的域名解析请求，并在Local DNS返回正确结果之前将伪造的DNS解析响应传递给终端用户，进而控制终端用户的域名访问行为。

另一种我们最常碰到的域名劫持现象是缓存污染。我们知道在接收到域名解析请求时，Local DNS首先会查找缓存，如果缓存命中就会直接返回缓存结果，不再进行递归DNS查询。这时候如果Local DNS针对部分域名的缓存进行更改，比如将缓存结果指向第三方的广告页，就会导致用户的访问请求被引导到这些广告页地址上。
### 1.7.2 调度不精确
- 解析转发<Br>
部分Local DNS供应商为了降低运营成本，会将请求到自己节点的域名解析请求转发给其他供应商的Local DNS节点，权威DNS在进行域名解析时会根据Local DNS的IP信息进行智能调度，导致域名解析得到的不是最优节点。

- Local DNS的布署分配不均匀
### 1.7.3 延迟大
DNS首次查询或缓存过期后的查询，需要递归遍历多个DNS服务器以获取最终的解析结果，这增加了网络请求的前置延时时间。

# 2 HTTPDNS
## 2.1 概念
客户端动态请求服务端，获取 HTTPDNS 服务器的 IP 列表，缓存到本地。需要域名解析时，根据客户端的地点、运营商等信息，在本地 HTTPDNS 服务器的IP 列表中，选择一个最佳节点发出 HTTP 的请求，节点接收到域名解析请求后会返回一个要访问的网站的 IP 地址。

## 2.2 精准调度
HTTPDNS在递归解析实现上优化了与权威DNS的交互，通过edns-client-subnet协议（ https://datatracker.ietf.org/doc/rfc7871 ）将终端用户的IP信息直接交付给权威DNS，这样权威DNS就可以忽略Local DNS IP信息，根据终端用户的IP信息进行精准调度，避免Local DNS的坐标干扰。

## 2.3 接入
目前阿里云以及腾讯云均有相关的HTTPDNS解析服务提供。

# 参考资料
[移动互联网时代，如何优化你的网络 —— 域名解析篇](https://developer.aliyun.com/article/58967)

[网络优化之HttpDNS域名解析](https://www.jianshu.com/p/f82bec845712)

[HTTPDNS原理](https://zhuanlan.zhihu.com/p/270596378)