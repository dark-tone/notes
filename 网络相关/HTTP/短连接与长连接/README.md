# 短连接与长连接
HTTP为请求/响应模式，当服务端返回了响应，本次HTTP请求就结束了，HTTP的短连接与长连接实质上是底层TCP的短连接与长连接。

**短连接**：客户端和服务器每进行一次HTTP操作，就建立一次连接（需要重复进行HTTP三次握手四次挥手）。

**长连接**：HTTP三次握手后建立连接，后续的HTTP通信复用连接不再需要进行握手（HTTP/1.1开始默认使用长连接）。

## 如何实现
前提需要客户端和服务端都支持长连接。客户端头部加上 ***Connection: keep-alive*** 开启（HTTP/1.1开始默认加上），如果不想使用长连接或要中断连接则把参数改为 ***Connection: close***，另外服务端可发送 ***Keep-Live: timeout=20,max=100*** （表示这个TCP通道可以保持20秒，max=100，表示这个长连接最多接收100次请求就断开） 告知客户端长连接的有效时间。

## 如何判断数据已传输完成？
### 1. 判断Content-Length头部
判断数据达到这个大小就知道数据传输结束了。
### 2. Transfer-Encoding: chunked
如果内容是分块传输会使用到Transfer-Encoding头部，这时候就要根据传输的数据块chunk来判断，数据传输结束的时候，最后的一个数据块chunk的长度是0。
> 每个分块的第一行是分块内容的大小，十六进制表示，后面跟CRLF(\r\n)，第一行本身以及分块内容末尾的CRLF不计入大小。第二行是分块内容，后面也跟CRLF。**最后一个分块虽然大小为零，但是必不可少，表示分块的结束，后面也跟CRLF，同时内容为空。最后，响应体再以CRLF结束**。

## TCP保活机制
类似于心跳机制，防止客户端已经非正常断开，但服务端仍保持连接的情况，保活机制是由一个保活计时器实现的。当计时器被激发，连接一段将发送一个保活探测报文，另一端接收报文的同时会发送一个ACK作为响应。发送探测报文后，可能会出现以下情况：
- 客户主机依然正常运行，且服务器可达。此时客户的TCP响应正常，服务器将保活定时器复位。
- 客户主机已经崩溃，并且关闭或者正在重新启动。上述情况下客户端都不能响应TCP。服务端将无法收到客户端对探测的响应。服务器总共发送10个这样的探测，每个间隔75秒。若服务器没有收到任何一个响应，它就认为客户端已经关闭并终止连接。
- 客户端崩溃并已经重新启动。服务器将收到一个对其保活探测的响应，这个响应是一个复位，使得服务器终止这个连接。
- 客户机正常运行，但是服务器不可达。这种情况与第二种状态类似。

### 弊端
- 在出现短暂的网络错误的时候，保活机制会使一个好的连接断开；
- 保活机制会占用不必要的带宽；

所以，保活机制是存在争议的，主要争议之处在于是否应在TCP协议层实现，有两种主要观点：其一，保活机制不必在TCP协议中提供，而应该由应用层实现；其二，认为大多数应用都需要保活机制，应该在TCP协议层实现。
> 保活功能在默认情况下是关闭的。没有经过应用层的请求，Linux系统不会提供保活功能。

## HTTP并发连接
RFC文档，客户端与服务器最多就连上两通道，但实际上并发连接数的上限由具体的客户端自己控制（比如Chrome允许对同一个域名Host建立6个TCP连接）。

## HTTP流水线技术
**概念**： 在一个TCP连接内，多个HTTP请求可以并行，下一个HTTP请求在上一个HTTP请求的应答完成之前就发起。

- 在 HTTP 1.1 存在 Pipelining 技术可以完成这个多个请求同时发送，但是由于浏览器默认关闭，所以可以认为这是不可行的。
>要求服务端返回响应数据的顺序必须跟客户端请求时的顺序一致，这样也就是要求FIFO，这容易导致Head-of-line blocking：第一个请求的响应发送影响到了后边的请求，因为这个原因导致HTTP流水线技术对性能的提升并不明显。另外，使用这个技术的还必须是幂等的HTTP方法，因为客户端无法得知当前已经处理到什么地步，重试后可能发生不可预测的结果。POST方法不是幂等的：同样的报文，第一次POST跟第二次POST在服务端的表现可能会不一样。

- 在 HTTP2 中由于 Multiplexing 特点的存在，多个 HTTP 请求可以在同一个 TCP 连接中并行进行。

# 参考文章
[【TCP/IP详解】TCP保活机制](https://blog.csdn.net/s_lisheng/article/details/87288445)

[HTTP长连接、短连接究竟是什么？](https://www.cnblogs.com/gotodsp/p/6366163.html)

[HTTP的长连接和短连接](https://www.cnblogs.com/cswuyg/p/3653263.html)